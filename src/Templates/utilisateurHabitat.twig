{% extends "base.html.twig" %}

{% block head_title %}Arcadia-Gestion des habitats
{% endblock %}

{% block head_description %}Gestion des habitats
{% endblock %}

{% block stylesheet %}
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
	<link rel="stylesheet" href="{{base_url}}public/scss/main.css">
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
{% endblock %}

{% block body %}

<a href="{{base_url}}">Accueil</a>
<a href="/admin">Admin</a>
<br><br>

{% if addResult is defined and addResult is not empty %}

	{# Page 'résultat' suite à une action créer, update ou delete terminée -------------------------------------#}

	{# résultat de l'action #}
	{{addResult}}
	<br>

	{# Liste des éléments liés pouvant empêcher la suppression #}
		{% if data is defined and data is not empty %}
			<h2>
		Liaisons relatives à l'élément à supprimer
	</h2>
	{% endif %}
		<a href="{{ base_url }}{{previousUrl}}"> Retour</a>

{% elseif modifySection is defined and modifySection == true %}

	{# Page 'update' pour mettre le nouveau nom -----------------------------------------------------------------#}

	<h2>Modification
		{{pageName}}:</h2>

	Ancien nom de la race:
	{{elements.valeur}}
	<br><br>
	Nouveau nom :
	<br>
	<form action="{{base_url}}{{updateUrl}}" method="post" enctype='multipart/form-data'>
		<input type="text" name="updatedName" id="">
		<input type="hidden" name="updateElementId" value={{ elements.id }}>
		<input type="hidden" name="tok" value={{ token }}>

		<button type="submit">Soumettre</button>

	</form>

	<a href="{{ base_url }}{{previousUrl}}">Retour</a>
{% else %}
	{# Page 'main' de la section avec CRUD ----------------------------------------------------------------------#}

	<div class='container-fluid'>
		<div class='row justify-content-center'>
			<h1 class="col-11 col-md-9 col-lg-8 col-xl-6 col-xxl-5 m-5 text-center">Bienvenue dans votre espace de gestion des habitats</h1>
		</div>
	</div>

	<br>
	<div class='container-fluid'>
		<div class='row justify-content-center'>
			<h2 class="col-11 col-md-9 col-lg-8 col-xl-6 col-xxl-5 m-5 text-center">Que voulez vous faire ?</h2>
		</div>
	</div>

	<div class='container-fluid'>
		<div class='row justify-content-start'>
			<h2 class="col-12 m-2">liste des
				{{pageName}}</h2>
		</div>

		{# Formulaire de recherche #}
		<form action="{{base_url}}{{previousUrl}}" method="get" enctype='multipart/form-data'>
			<input type="text" name='search'>
			<input type="hidden" name="tok" value={{ token }}>
			<button type="submit">Recherche
				{{pageName}}</button>
			<button onclick="location.href='{{ base_url }}{{previousUrl}}'">Reset</button>
		</form>

		{% if elements == 'une erreur est survenue' %}
			<b>une erreur est survenue</b>
		{% else %}

			{# Tableau des éléments #}
			<table>
				<thead>
					<tr>
						<th>Nom
							{{pageName}}</th>
						<th>Description</th>
						<th>Avis vétérinaire</th>
						<th>Photos</th>
						<th>Modifier</th>
						<th>Supprimer</th>
					</tr>
				</thead>

				<tbody>
					{% for element in elements %}
						<tr>
							<td>{{ element.valeur|raw  }}</td>
							<td>{{ element.description|raw }}</td>
							<td>{{ element.avis|raw }}</td>
							<td>

								{% if element.images is defined %}
									<div style="margin-right: 10px; display: flex; gap: 10px;">
										{% for image in element.images %}
											<img src="data:{{ image.type }};base64,{{ image.data }}" alt="Image" style="width: 75px; height: 75px;">
										{% endfor %}
									</div>
								{% else %}
									Aucune image disponible
								{% endif %}

							</td>

							<td>
								<form method="get" action="{{base_url}}{{updateUrl}}" enctype='multipart/form-data'>
									<input type="hidden" name="UpdateElementId" value={{ element.id }}>
									<input type="hidden" name="tok" value={{ token }}>
									<button type="submit">Modifier</button>
								</form>
							</td>

							<td>
								<form method="post" action="{{base_url}}{{deleteUrl}}" enctype='multipart/form-data'>
									<input type="hidden" name="deleteElementId" value={{ element.id }}>
									<input type="hidden" name="tok" value={{ token }}>
									<button type="submit">Supprimer</button>
								</form>
							</td>
						</tr>
					{% endfor %}
				</tbody>
			</table>

			{# Pagination #}
			<div class="pagination">
				page
				<br>
				{% if activePage > 1 %}
					<a href="?page={{ activePage - 1 }}&search={{search}}&tok={{token}}">Page précédente</a>
				{% endif %}

				{% for page in 1..pageMax %}
					{% if page == activePage %}
						<span class="current-page">{{ page }}</span>
					{% else %}
						<a href="?page={{ page }}&search={{search}}&tok={{token}}">{{ page }}</a>
					{% endif %}
				{% endfor %}

				{% if activePage < pageMax %}
					<a href="?page={{ activePage + 1 }}&search={{search}}&tok={{token}}">Page suivante</a>
				{% endif %}
			</div><br>
		</div>

	{% endif %}

	<h2>Souhaitez vous faire un ajout :
		{{pageName}}
		?</h2>

	<form id='addelement' action="{{base_url}}{{addUrl}}" method="post" enctype='multipart/form-data'>
		<label for="addElementName">Nom du nouvel habitat :
		</label><br>
		<input type="text" required name="addElementName" id="" placeholder="{{pageName}}">
		<br><br>

		<label for="addElementDesc">Description du nouvel habitat :
		</label>
		<br>
		<textarea name="addElementDesc" required id="" cols="30" rows="3"></textarea><br><br>

		<label for="addElementImg">Images du nouvel habitat (jpg, jpeg, png et < 100Ko):
		</label>
		<br>
		<input type="file" name="addElementImg[]" id="addElementImg" multiple></input><br>
	<br>

	<input type="hidden" name="tok" value={{ token }}>
	<button type="submit">Soumettre</button>
</form>

{# Retour vers page d'accueil admin #}
<a href="{{base_url}}admin">Retour</a>

<script>
	function validateFileUpload(event) { // Récupère l'élément input file
let fileInput = document.getElementById('addElementImg');

// Récupère les fichiers à envoyer
let files = fileInput.files;

// Liste des extensions autorisées (ajoutez ici les extensions que vous souhaitez autoriser)
let allowedExtensions = ['jpg', 'jpeg', 'png'];
let maxSizeInBytes = 0.1 * 1024 * 1024;
// 5 Mo

// Boucle à travers chaque fichier sélectionné
for (let i = 0; i < files.length; i++) {
let fileName = files[i].name;
let fileExtension = fileName.split('.').pop().toLowerCase();
let fileSize = files[i].size;
// Taille du fichier en octets

// Vérifie si l'extension du fichier est autorisée
if (allowedExtensions.indexOf(fileExtension) === -1) {
event.preventDefault();
// Empêche l'envoi du formulaire
// Affiche un message d'erreur
alert('Le fichier ' + fileName + ' n\'est pas autorisé. Veuillez sélectionner un fichier avec une extension ' + allowedExtensions.join(', '));
return false; // Empêche l'envoi du formulaire
}

// Vérifie si la taille du fichier est supérieure à la limite autorisée
if (fileSize > maxSizeInBytes) {
event.preventDefault();
// Empêche l'envoi du formulaire

// Affiche un message d'erreur
alert('Le fichier ' + fileName + ' dépasse la taille maximale autorisée de 100 Ko.');
return false; // Empêche l'envoi du formulaire
}
}

return true; // Autorise l'envoi du formulaire si tous les fichiers sont valides
}

// Attache la fonction de validation au formulaire avant l'envoi
let form = document.getElementById('addelement');
form.onsubmit = function () {
return validateFileUpload(event);
};
</script>{% endif %}{% endblock %}
